@{
    ViewData["Title"] = "Kayıt Ol";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="bi bi-person-plus"></i> Kayıt Ol</h3>
                </div>
                <div class="card-body p-4">
                    <div id="successMessage" class="alert alert-success d-none" role="alert"></div>
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

                    <form id="registerForm" onsubmit="return registerViaApi(event)">
                        <div id="validationSummary" class="text-danger mb-3" style="display: none;"></div>

                        <div class="mb-3">
                            <label for="FirstName" class="form-label">Ad</label>
                            <input type="text" id="FirstName" name="FirstName" class="form-control" required />
                            <span id="FirstNameError" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="LastName" class="form-label">Soyad</label>
                            <input type="text" id="LastName" name="LastName" class="form-control" required />
                            <span id="LastNameError" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Email" class="form-label">E-posta</label>
                            <input type="email" id="Email" name="Email" class="form-control" required />
                            <span id="EmailError" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Phone" class="form-label">Telefon</label>
                            <input type="text" id="Phone" name="Phone" class="form-control" required />
                            <span id="PhoneError" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Password" class="form-label">Şifre</label>
                            <input type="password" id="Password" name="Password" class="form-control" required minlength="6" />
                            <span id="PasswordError" class="text-danger"></span>
                            <small class="form-text text-muted">Şifre en az 6 karakter olmalıdır.</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-plus"></i> Kayıt Ol
                            </button>
                            <a asp-action="Login" class="btn btn-outline-secondary">
                                <i class="bi bi-box-arrow-in-right"></i> Zaten hesabınız var mı? Giriş Yap
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0;
    }
    
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>

<script>
    // API üzerinden üye kaydı
    async function registerViaApi(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        const validationSummary = document.getElementById('validationSummary');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Form verilerini topla
        const memberData = {
            firstName: document.getElementById('FirstName').value.trim(),
            lastName: document.getElementById('LastName').value.trim(),
            email: document.getElementById('Email').value.trim(),
            phone: document.getElementById('Phone').value.trim(),
            password: document.getElementById('Password').value
        };
        
        // Validasyon
        if (!memberData.firstName) {
            showValidationError('Ad alanı zorunludur.');
            return false;
        }
        
        if (!memberData.lastName) {
            showValidationError('Soyad alanı zorunludur.');
            return false;
        }
        
        if (!memberData.email || memberData.email.indexOf('@@') === -1) {
            showValidationError('Geçerli bir e-posta adresi giriniz.');
            return false;
        }
        
        if (!memberData.phone) {
            showValidationError('Telefon alanı zorunludur.');
            return false;
        }
        
        if (!memberData.password || memberData.password.length < 6) {
            showValidationError('Şifre en az 6 karakter olmalıdır.');
            return false;
        }
        
        // Loading durumu
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Kaydediliyor...';
        validationSummary.style.display = 'none';
        successMessage.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        try {
            const response = await fetch('/api/api/members/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(memberData)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}`);
            }
            
            const result = await response.json();
            if (result.success) {
                successMessage.textContent = 'Kayıt başarılı! Yönlendiriliyorsunuz...';
                successMessage.classList.remove('d-none');
                
                // 2 saniye sonra giriş sayfasına yönlendir
                setTimeout(() => {
                    window.location.href = '/Account/Login';
                }, 2000);
            } else {
                throw new Error(result.message || 'Kayıt işlemi başarısız');
            }
        } catch (error) {
            console.error('Register error:', error);
            errorMessage.textContent = 'Kayıt sırasında hata oluştu: ' + error.message;
            errorMessage.classList.remove('d-none');
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        }
        
        return false;
    }
    
    function showValidationError(message) {
        const validationSummary = document.getElementById('validationSummary');
        validationSummary.innerHTML = '<ul class="mb-0"><li>' + message + '</li></ul>';
        validationSummary.style.display = 'block';
    }
</script>
