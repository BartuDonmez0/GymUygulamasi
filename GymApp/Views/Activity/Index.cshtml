@{
    ViewData["Title"] = "Aktiviteler";
    var gymCenterId = ViewData["GymCenterId"] as int?;
}

<div class="container px-3 px-md-4">
@if (gymCenterId.HasValue)
{
    <div class="mb-3">
        <a href="@Url.Action("Details", "GymCenter", new { id = gymCenterId.Value })" class="text-decoration-none text-dark">
            <i class="bi bi-arrow-left"></i> Spor Salonuna Dön
        </a>
    </div>
}

    <!-- Filter Section -->
    <div class="card mb-4 shadow-sm border-dark">
        <div class="card-body bg-light">
            <div class="row align-items-end">
                <div class="col-12 col-md-4 mb-3 mb-md-0">
                    <label class="form-label fw-bold text-dark">
                        <i class="bi bi-list-check"></i> Aktivite Tipi
                    </label>
                    <select id="typeFilter" class="form-select">
                        <option value="">Tümü</option>
                    </select>
                </div>
                <div class="col-12 col-md-4 mb-3 mb-md-0">
                    <label class="form-label fw-bold text-dark">
                        <i class="bi bi-currency-dollar"></i> Fiyat Aralığı
                    </label>
                    <select id="priceFilter" class="form-select">
                        <option value="">Tümü</option>
                        <option value="0-200">0 - 200 ₺</option>
                        <option value="200-500">200 - 500 ₺</option>
                        <option value="500-1000">500 - 1000 ₺</option>
                        <option value="1000+">1000+ ₺</option>
                    </select>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-end gap-2">
                    <button type="button" class="btn btn-dark w-100" onclick="filterActivities()">
                        <i class="bi bi-funnel"></i> Filtrele
                    </button>
                    <button type="button" class="btn btn-outline-dark" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Grid - API'den dinamik yüklenecek -->
    <div class="row g-4" id="activitiesContainer">
        <div class="col-12 text-center">
            <span class="spinner-border" role="status"></span>
            <p class="mt-2">Aktiviteler yükleniyor...</p>
            </div>
    </div>

    <!-- No Results Message (hidden by default) -->
    <div id="noResults" class="alert alert-dark text-center d-none border-dark">
        <i class="bi bi-info-circle"></i> Seçilen filtreye uygun aktivite bulunamadı.
    </div>
</div>

<style>
    .activity-card {
        transition: all 0.3s ease;
    }

    .activity-card .card {
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .activity-card:hover .card {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3) !important;
        border-color: #000;
    }

    .activity-image-wrapper {
        position: relative;
        overflow: hidden;
    }

    .activity-badge {
        position: absolute;
        top: 15px;
        right: 15px;
    }

    .activity-badge .badge {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }

    .activity-details {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }

    .form-select:focus {
        border-color: #000;
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
    }

    .btn-dark:hover {
        background-color: #000;
        border-color: #000;
    }

    @@media (max-width: 768px) {
        .activity-card {
            margin-bottom: 1.5rem;
        }

        .activity-card .card-body {
            padding: 1.25rem !important;
        }

        .activity-card .card-title {
            font-size: 1.1rem;
        }

        .activity-card .card-text {
            font-size: 0.9rem;
        }
    }

    @@media (max-width: 576px) {
        .card-body {
            padding: 1rem !important;
        }

        .activity-card .card-title {
            font-size: 1rem;
            text-align: center;
        }

        .activity-card .card-text {
            font-size: 0.85rem;
            text-align: center;
        }

        .activity-badge {
            top: 10px;
            right: 10px;
        }

        .activity-badge .badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
        }

        .activity-details {
            text-align: center;
        }

        .card-footer .d-grid .btn {
            width: 100%;
        }
    }
</style>

<script>
    // API üzerinden aktiviteleri yükleme
    // Aktivite listesini API'den yükle
    async function loadActivities() {
        const container = document.getElementById('activitiesContainer');
        if (!container) return;

        container.innerHTML = '<div class="col-12 text-center"><span class="spinner-border"></span> Yükleniyor...</div>';

        try {
            const response = await fetch('/api/api/activities');
            if (!response.ok) throw new Error('HTTP ' + response.status);

            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'API hatası');

            // API'den gelen aktiviteler (typeId: enum değeri, type: isim, imageUrl: görsel)
            const activities = result.data || [];

            if (!activities.length) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-dark text-center border-dark"><i class="bi bi-info-circle"></i> Henüz aktivite tanımlanmamıştır.</div></div>';
                return;
            }

            // Aktivite tiplerini select'e ekle (benzersiz isim listesi)
            const typeFilter = document.getElementById('typeFilter');
            const uniqueTypes = [...new Set(activities
                .filter(a => {
                    // Property isimleri hem camelCase hem PascalCase destekleniyor
                    const type = a.type || a.Type || '';
                    return type.length > 0;
                })
                .map(a => a.type || a.Type || ''))]  // type = string isim
                .filter(t => t.length > 0)
                .sort();

            uniqueTypes.forEach(typeName => {
                const option = document.createElement('option');
                option.value = typeName;          // filtreleme için isim kullan
                option.textContent = typeName;    // dropdownda isim göster
                typeFilter.appendChild(option);
            });

            // Aktiviteleri render et
            const activityCards = activities.map(activity => {
                // Property isimleri hem camelCase hem PascalCase destekleniyor
                const id = activity.id || activity.Id || 0;
                const name = activity.name || activity.Name || 'İsimsiz Aktivite';
                const type = activity.type || activity.Type || '';
                const description = (activity.description || activity.Description || '');
                const descriptionDisplay = description && description.length > 100
                    ? description.substring(0, 100) + '...'
                    : (description || 'Açıklama bulunmamaktadır.');
                const imageUrl = activity.imageUrl || activity.ImageUrl || 'https://via.placeholder.com/400x250?text=Activity';
                const duration = activity.duration || activity.Duration || 0;
                const price = parseFloat(activity.price || activity.Price || 0);

                return `<div class="col-12 col-md-6 col-lg-4 activity-card" 
                    data-type="${type}" 
                    data-price="${price}">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="activity-image-wrapper">
                            <img src="${imageUrl}" 
                                class="card-img-top" alt="${name}" 
                                style="height: 200px; object-fit: cover; transition: transform 0.3s ease;"
                                onmouseover="this.style.transform='scale(1.1)';"
                                onmouseout="this.style.transform='scale(1)';"
                                onerror="this.src='https://via.placeholder.com/400x250?text=Activity'">
                            <div class="activity-badge">
                                <span class="badge bg-dark text-white">${type}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3 text-dark">${name}</h5>
                            <p class="card-text text-muted small mb-3">${descriptionDisplay}</p>
                            <div class="activity-details mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-dark">
                                        <i class="bi bi-clock text-dark"></i> Süre
                                    </span>
                                    <strong class="text-dark">${duration} dakika</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark">
                                        <i class="bi bi-currency-dollar text-dark"></i> Fiyat
                                    </span>
                                    <strong class="text-dark fs-5">${price.toFixed(2)} ₺</strong>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <div class="d-grid gap-2">
                                <a href="/Activity/Details/${id}" class="btn btn-outline-dark">
                                    <i class="bi bi-info-circle"></i> Detaylar
                                </a>
                                <a href="/Appointment/Index" class="btn btn-dark">
                                    <i class="bi bi-calendar-plus"></i> Randevu Al
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = activityCards;
        } catch (error) {
            console.error('API hata:', error);
            container.innerHTML = '<div class="col-12"><div class="alert alert-danger text-center"><i class="bi bi-exclamation-triangle"></i> API\'den veriler alınırken hata oluştu: ' + error.message + '</div></div>';
        }
    }

    function filterActivities() {
        const typeFilter = document.getElementById('typeFilter').value;
        const priceFilter = document.getElementById('priceFilter').value;
        const activities = document.querySelectorAll('.activity-card');
        let visibleCount = 0;

        activities.forEach(activity => {
            const activityType = activity.getAttribute('data-type');
            const activityPrice = parseFloat(activity.getAttribute('data-price'));
            
            let showActivity = true;

            if (typeFilter && activityType !== typeFilter) {
                showActivity = false;
            }

            if (priceFilter && showActivity) {
                switch (priceFilter) {
                    case '0-200':
                        if (activityPrice < 0 || activityPrice > 200) showActivity = false;
                        break;
                    case '200-500':
                        if (activityPrice <= 200 || activityPrice > 500) showActivity = false;
                        break;
                    case '500-1000':
                        if (activityPrice <= 500 || activityPrice > 1000) showActivity = false;
                        break;
                    case '1000+':
                        if (activityPrice <= 1000) showActivity = false;
                        break;
                }
            }

            if (showActivity) {
                activity.style.display = '';
                visibleCount++;
            } else {
                activity.style.display = 'none';
            }
        });

        const noResults = document.getElementById('noResults');
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
    }

    function clearFilters() {
        document.getElementById('typeFilter').value = '';
        document.getElementById('priceFilter').value = '';
        filterActivities();
    }

    // Sayfa yüklendiğinde API'den verileri çek
    document.addEventListener('DOMContentLoaded', function() {
        loadActivities();
        document.getElementById('typeFilter').addEventListener('change', filterActivities);
        document.getElementById('priceFilter').addEventListener('change', filterActivities);
    });
</script>
