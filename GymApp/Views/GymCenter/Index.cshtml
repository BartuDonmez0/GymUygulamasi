@{
    ViewData["Title"] = "Spor Salonları";
}

<div class="container px-3 px-md-4">
<!-- Filtreleme Formu -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-12 col-md-4">
                    <label for="dayOfWeek" class="form-label text-dark">
                        <i class="bi bi-calendar-week"></i> Çalışma Günü
                    </label>
                <select class="form-select" id="dayOfWeek">
                    <option value="">Tüm Günler</option>
                        <option value="0">Pazar</option>
                        <option value="1">Pazartesi</option>
                        <option value="2">Salı</option>
                        <option value="3">Çarşamba</option>
                        <option value="4">Perşembe</option>
                        <option value="5">Cuma</option>
                        <option value="6">Cumartesi</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                    <label for="activityId" class="form-label text-dark">
                        <i class="bi bi-list-check"></i> Aktivite
                    </label>
                <select class="form-select" id="activityId">
                    <option value="">Tüm Aktiviteler</option>
                </select>
            </div>
                <div class="col-12 col-md-4 d-flex align-items-end gap-2">
                    <button type="button" class="btn btn-dark w-100" onclick="applyFilters()">
                    <i class="bi bi-funnel"></i> Filtrele
                </button>
                <button type="button" class="btn btn-outline-dark" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Temizle
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Spor Salonları Container - API'den dinamik yüklenecek -->
    <div id="gymCentersContainer">
    <div class="row g-4">
            <div class="col-12 text-center">
                <span class="spinner-border" role="status"></span>
                <p class="mt-2">Spor salonları yükleniyor...</p>
            </div>
    </div>
    </div>
</div>

<style>
    .gym-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .gym-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
    }

    .gym-card-image {
        position: relative;
        overflow: hidden;
    }

    .gym-card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gym-card:hover .gym-card-overlay {
        opacity: 1;
    }

    .gym-card .card-body {
        padding: 1.5rem;
    }

    .gym-card .card-title {
        color: #333;
        margin-bottom: 0.75rem;
        text-align: center;
    }

    .gym-card .card-text {
        text-align: center;
    }

    .gym-card .d-flex {
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
    }

    .gym-card .btn {
        width: 100%;
        max-width: 200px;
    }

    @@media (max-width: 768px) {
        .gym-card .card-body {
            padding: 1.25rem;
        }

        .gym-card .card-title {
            font-size: 1.15rem;
        }

        .gym-card .card-text {
            font-size: 0.9rem;
        }
    }

    @@media (max-width: 576px) {
        .gym-card-image img {
            height: 200px !important;
        }

        .gym-card .card-body {
            padding: 1rem;
        }

        .gym-card .card-title {
            font-size: 1.05rem;
        }

        .gym-card .card-text {
            font-size: 0.85rem;
        }

        .gym-card .btn {
            width: 100%;
            max-width: 100%;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
        }
    }
</style>

<script>
    // Aktivite listesini API'den yükle
    async function loadActivities() {
        try {
            const response = await fetch('/api/api/activities');
            if (!response.ok) throw new Error('HTTP ' + response.status);
            
            const result = await response.json();
            if (result.success && result.data) {
                // Dropdown elementi seç
                const select = document.getElementById('activityId');
                
                // Duplicate kontrolü için Set kullan - aynı ID'li aktiviteleri tekrar eklememek için
                const addedIds = new Set();
                
                // Her aktiviteyi kontrol et ve dropdown'a ekle
                result.data.forEach(activity => {
                    // Property isimleri hem camelCase hem PascalCase destekleniyor (API response formatına göre)
                    const activityId = activity.id || activity.Id || 0;
                    const activityName = activity.name || activity.Name || '';
                    
                    // Aynı ID'li aktivite zaten eklenmişse atla (duplicate önleme)
                    // Geçerli ID ve isim kontrolü yap
                    if (activityId > 0 && !addedIds.has(activityId) && activityName) {
                        // ID'yi Set'e ekle (bir sonraki kontrol için)
                        addedIds.add(activityId);
                        
                        // Yeni option elementi oluştur
                        const option = document.createElement('option');
                        option.value = activityId; // Option değeri aktivite ID'si
                        option.textContent = activityName; // Görünen metin aktivite adı
                        
                        // Dropdown'a ekle
                        select.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Aktiviteler yüklenirken hata:', error);
        }
    }

    // Filtreleri uygula
    function applyFilters() {
        const dayOfWeek = document.getElementById('dayOfWeek').value;
        const activityId = document.getElementById('activityId').value;
        loadGymCentersFromApi(activityId, dayOfWeek);
        }

    // Filtreleri temizle
    function clearFilters() {
        document.getElementById('dayOfWeek').value = '';
        document.getElementById('activityId').value = '';
        loadGymCentersFromApi(null, null);
    }

    // API üzerinden spor salonlarını yükleme (LINQ filtreleme ile)
    async function loadGymCentersFromApi(activityId, dayOfWeek) {
        const container = document.getElementById('gymCentersContainer');
        if (!container) return;

        container.innerHTML = '<div class="row g-4"><div class="col-12 text-center"><span class="spinner-border"></span> Yükleniyor...</div></div>';

        try {
            let url = '/api/api/gym-centers';
        const params = new URLSearchParams();
            
            // Çalışma günü filtresi
            if (dayOfWeek !== null && dayOfWeek !== undefined && dayOfWeek !== '') {
                params.append('dayOfWeek', dayOfWeek);
            }
            
            // Aktivite filtresi için özel endpoint kullan
            if (activityId) {
                url = `/api/api/gym-centers-by-activity?activityId=${activityId}`;
                if (dayOfWeek !== null && dayOfWeek !== undefined && dayOfWeek !== '') {
                    params.append('dayOfWeek', dayOfWeek);
                }
            }
            
            // Parametreleri URL'ye ekle
            if (params.toString()) {
                url += (url.includes('?') ? '&' : '?') + params.toString();
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('HTTP ' + response.status);
        
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'API hatası');

            let gymCenters = result.data || [];

            if (!gymCenters.length) {
                container.innerHTML = '<div class="row g-4"><div class="col-12"><div class="alert alert-info text-center"><i class="bi bi-info-circle"></i> Filtrelere uygun spor salonu bulunamadı.</div></div></div>';
                return;
            }

            const dayNames = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
            
            const gymCenterCards = gymCenters.map(gc => {
                // Property isimleri hem camelCase hem PascalCase destekleniyor
                const id = gc.id || gc.Id || 0;
                const name = gc.name || gc.Name || 'İsimsiz Spor Salonu';
                const address = gc.address || gc.Address || 'Adres belirtilmemiş';
                const imageUrl = gc.imageUrl || gc.ImageUrl || 'https://via.placeholder.com/400x250?text=Gym';
                const workingHoursJson = gc.workingHoursJson || gc.WorkingHoursJson || '[]';
                
                // Çalışma saatleri parse et
                let workingHoursDisplay = "Belirtilmemiş";
                try {
                    if (workingHoursJson && workingHoursJson !== '[]') {
                        const workingHours = JSON.parse(workingHoursJson);
                        if (Array.isArray(workingHours) && workingHours.length > 0) {
                            const firstItem = workingHours[0];
                            const day = firstItem.Day !== undefined ? firstItem.Day : (firstItem.day !== undefined ? firstItem.day : undefined);
                            
                            if (day !== undefined) {
                                const dayName = dayNames[day] || `Gün ${day}`;
                                const hours = firstItem.Hours || firstItem.hours;
                                const timeRange = firstItem.TimeRange || firstItem.timeRange;
                                
                                if (hours && Array.isArray(hours)) {
                                    const hoursFormatted = hours.slice(0, 2).map(h => {
                                        const parts = h.split('-');
                                        return parts.length === 2 ? `${parts[0]}:00-${parts[1]}:00` : h;
                                    });
                                    workingHoursDisplay = `${dayName}: ${hoursFormatted.join(", ")}`;
                                    if (workingHours.length > 1) {
                                        workingHoursDisplay += ` (+${workingHours.length - 1} gün)`;
                                    }
                                } else if (timeRange) {
                                    workingHoursDisplay = `${dayName}: ${timeRange}`;
                                    if (workingHours.length > 1) {
                                        workingHoursDisplay += ` (+${workingHours.length - 1} gün)`;
                                    }
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('WorkingHoursJson parse hatası:', e);
                    workingHoursDisplay = "Belirtilmemiş";
                }

                const description = (gc.description || gc.Description || '');
                const descriptionDisplay = description && description.length > 100
                    ? description.substring(0, 100) + '...'
                    : (description || 'Açıklama bulunmamaktadır.');

                return `<div class="col-12 col-md-6 col-lg-4">
                    <div class="gym-card card h-100 shadow-sm">
                        <div class="gym-card-image">
                            <img src="${imageUrl}" 
                                class="card-img-top" alt="${name}" 
                                style="height: 250px; object-fit: cover;"
                                onerror="this.src='https://via.placeholder.com/400x250?text=Gym'">
                            <div class="gym-card-overlay">
                                <a href="/GymCenter/Details/${id}" class="btn btn-light btn-sm">
                                    <i class="bi bi-eye"></i> Detayları Gör
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title fw-bold">${name}</h5>
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-geo-alt"></i> ${address}
                            </p>
                            <p class="card-text">${descriptionDisplay}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${workingHoursDisplay}
                                </small>
                                <a href="/GymCenter/Details/${id}" class="btn btn-primary btn-sm">
                                    Detaylar <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `<div class="row g-4">${gymCenterCards}</div>`;
        } catch (error) {
            console.error('API hata:', error);
            container.innerHTML = '<div class="row g-4"><div class="col-12"><div class="alert alert-danger text-center"><i class="bi bi-exclamation-triangle"></i> API\'den veriler alınırken hata oluştu: ' + error.message + '</div></div></div>';
        }
    }

    // Sayfa yüklendiğinde API'den verileri çek
    document.addEventListener('DOMContentLoaded', function() {
        loadActivities();
        
        const urlParams = new URLSearchParams(window.location.search);
        const activityId = urlParams.get('activityId');
        const dayOfWeek = urlParams.get('dayOfWeek');
        
        if (dayOfWeek) {
            document.getElementById('dayOfWeek').value = dayOfWeek;
        }
        
        loadGymCentersFromApi(activityId, dayOfWeek);
        
        setTimeout(() => {
            if (activityId) {
                document.getElementById('activityId').value = activityId;
    }
        }, 500);
    });
</script>
