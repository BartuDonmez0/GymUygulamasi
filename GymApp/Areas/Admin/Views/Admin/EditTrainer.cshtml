@model GymApp.Entities.Trainer
@{
    ViewData["Title"] = "Antrenör Düzenle";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-pencil"></i> Antrenör Düzenle</h3>
                </div>
                <div class="card-body">
                    <form asp-action="EditTrainer" method="post">
                        <input type="hidden" asp-for="Id" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label">Ad</label>
                                <input asp-for="FirstName" class="form-control" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label">Soyad</label>
                                <input asp-for="LastName" class="form-control" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">E-posta</label>
                            <input asp-for="Email" type="email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Phone" class="form-label">Telefon</label>
                            <input asp-for="Phone" class="form-control" />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ProfilePhotoUrl" class="form-label">Profil Fotoğrafı URL</label>
                            <input asp-for="ProfilePhotoUrl" type="url" class="form-control" placeholder="https://example.com/photo.jpg" />
                            <span asp-validation-for="ProfilePhotoUrl" class="text-danger"></span>
                            <small class="form-text text-muted">Antrenörün profil fotoğrafı için bir URL giriniz (opsiyonel).</small>
                            @if (!string.IsNullOrEmpty(Model.ProfilePhotoUrl))
                            {
                                <div class="mt-2">
                                    <img src="@Model.ProfilePhotoUrl" alt="Profil Fotoğrafı" class="img-thumbnail" style="max-width: 150px; max-height: 150px;" onerror="this.style.display='none'" />
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Uzmanlık Alanları (Aktiviteler) <span class="text-danger">*</span></label>
                            <small class="form-text text-muted d-block mb-2">Antrenörün yapabileceği aktiviteleri seçiniz.</small>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                @{
                                    var activities = ViewBag.Activities as List<GymApp.Entities.Activity> ?? new List<GymApp.Entities.Activity>();
                                    var selectedActivityIds = Model.TrainerActivities?.Select(ta => ta.ActivityId).ToList() ?? new List<int>();
                                }
                                @if (activities.Any())
                                {
                                    <div class="row">
                                        @foreach (var activity in activities)
                                        {
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input activity-checkbox" 
                                                           type="checkbox" 
                                                           name="SelectedActivityIds" 
                                                           value="@activity.Id" 
                                                           id="activity_@activity.Id"
                                                           @(selectedActivityIds.Contains(activity.Id) ? "checked" : "") />
                                                    <label class="form-check-label" for="activity_@activity.Id">
                                                        @activity.Name
                                                        <small class="text-muted">(@activity.GymCenter?.Name)</small>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">Henüz aktivite eklenmemiş. Önce aktivite ekleyin.</p>
                                }
                            </div>
                            <input type="hidden" id="selectedActivityIdsInput" name="SelectedActivityIds" value="" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="GymCenterId" class="form-label">Spor Salonu <span class="text-danger">*</span></label>
                            <select asp-for="GymCenterId" class="form-select" id="gymCenterSelect" required>
                                <option value="">Spor Salonu Seçiniz</option>
                                @foreach (var gymCenter in ViewBag.GymCenters ?? new List<GymApp.Entities.GymCenter>())
                                {
                                    @if (Model.GymCenterId == gymCenter.Id)
                                    {
                                        <option value="@gymCenter.Id" selected>@gymCenter.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@gymCenter.Id">@gymCenter.Name</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="GymCenterId" class="text-danger"></span>
                            <small class="form-text text-muted">Spor salonu seçildikten sonra çalışma saatleri görünecektir.</small>
                        </div>

                        <div class="mb-4" id="workingHoursSection" style="display: none;">
                            <label class="form-label fw-bold">Çalışma Saatleri <span class="text-danger">*</span></label>
                            <small class="form-text text-muted d-block mb-3">Seçilen spor salonunun çalışma saatleri içinden antrenörün çalışacağı saatleri seçiniz. <strong class="text-danger">En az bir gün için çalışma saati seçilmesi zorunludur.</strong></small>
                            <input type="hidden" asp-for="WorkingHoursJson" id="workingHoursJsonInput" value="@(Model.WorkingHoursJson ?? "[]")" />
                            <div id="workingHoursError" class="alert alert-danger d-none mb-3" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Hata:</strong> En az bir gün için çalışma saati seçmeniz gerekmektedir.
                            </div>
                            <div id="workingHoursContainer">
                                <!-- Çalışma saatleri buraya eklenecek -->
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Güncelle
                            </button>
                            <a href="@Url.Action("Trainers", "Admin")" class="btn btn-secondary">
                                <i class="bi bi-x-lg"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Aktivite seçimlerini yönet
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.activity-checkbox');
            const hiddenInput = document.getElementById('selectedActivityIdsInput');
            
            function updateSelectedActivities() {
                const selectedIds = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value)
                    .join(',');
                hiddenInput.value = selectedIds;
            }
            
            // İlk yüklemede mevcut seçimleri güncelle
            updateSelectedActivities();
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedActivities);
            });
            
            // Form submit öncesi kontrol
            document.querySelector('form').addEventListener('submit', function(e) {
                updateSelectedActivities();
                const selectedCount = hiddenInput.value.split(',').filter(id => id !== '').length;
                if (selectedCount === 0) {
                    e.preventDefault();
                    alert('Lütfen en az bir aktivite seçiniz.');
                    return false;
                }
            });
        });
        
        // Spor salonları ve çalışma saatleri
        let gymCentersData = [];
        try {
            const gymCentersJson = @Html.Raw(ViewBag.GymCentersJson ?? "[]");
            gymCentersData = typeof gymCentersJson === 'string' ? JSON.parse(gymCentersJson) : gymCentersJson;
            console.log('Yüklenen spor salonları:', gymCentersData);
        } catch (e) {
            console.error('Spor salonları JSON parse hatası:', e);
            gymCentersData = [];
        }
        let workingHoursData = {}; // { "1": ["10-11", "11-12"], "2": ["14-15", "15-16"] }
        let selectedGymCenterHours = {}; // Seçilen spor salonunun çalışma saatleri
        
        // Mevcut antrenör çalışma saatlerini yükle
        try {
            const jsonInput = document.getElementById('workingHoursJsonInput');
            if (jsonInput && jsonInput.value) {
                const parsedData = JSON.parse(jsonInput.value);
                if (Array.isArray(parsedData)) {
                    parsedData.forEach(item => {
                        if (item.Hours && Array.isArray(item.Hours)) {
                            workingHoursData[item.Day] = item.Hours;
                        } else if (item.TimeRange) {
                            // Eski format - saat aralığını saat dilimlerine çevir
                            const timeRange = item.TimeRange;
                            const [start, end] = timeRange.split('-');
                            const startHour = parseInt(start.split(':')[0]);
                            const endHour = parseInt(end.split(':')[0]);
                            const hours = [];
                            for (let h = startHour; h < endHour; h++) {
                                hours.push(`${h.toString().padStart(2, '0')}-${(h + 1).toString().padStart(2, '0')}`);
                            }
                            workingHoursData[item.Day] = hours;
                        }
                    });
                }
            }
        } catch (e) {
            console.error('JSON parse hatası:', e);
            workingHoursData = {};
        }
        
        const daysOfWeek = [
            { value: 0, text: 'Pazar' },
            { value: 1, text: 'Pazartesi' },
            { value: 2, text: 'Salı' },
            { value: 3, text: 'Çarşamba' },
            { value: 4, text: 'Perşembe' },
            { value: 5, text: 'Cuma' },
            { value: 6, text: 'Cumartesi' }
        ];

        // Spor salonu seçildiğinde veya sayfa yüklendiğinde
        function loadGymCenterHours() {
            const gymCenterId = document.getElementById('gymCenterSelect').value;
            const workingHoursSection = document.getElementById('workingHoursSection');
            
            if (!gymCenterId) {
                workingHoursSection.style.display = 'none';
                return;
            }
            
            // Seçilen spor salonunun çalışma saatlerini bul
            // gymCenterId string, gc.Id number olabilir, bu yüzden karşılaştırmayı düzelt
            const gymCenterIdNum = parseInt(gymCenterId);
            const gymCenter = gymCentersData.find(gc => {
                const gcId = typeof gc.Id === 'string' ? parseInt(gc.Id) : gc.Id;
                return gcId === gymCenterIdNum;
            });
            
            if (!gymCenter) {
                console.error('Spor salonu bulunamadı. ID:', gymCenterId, 'Mevcut salonlar:', gymCentersData);
                workingHoursSection.style.display = 'none';
                return;
            }
            
            console.log('Spor salonu bulundu:', gymCenter);
            
            try {
                const hoursData = JSON.parse(gymCenter.WorkingHoursJson || '[]');
                selectedGymCenterHours = {};
                hoursData.forEach(item => {
                    if (item.Hours && Array.isArray(item.Hours)) {
                        selectedGymCenterHours[item.Day] = item.Hours;
                    } else if (item.TimeRange) {
                        // Eski format desteği - TimeRange'i Hours array'ine çevir
                        const timeRange = item.TimeRange;
                        const [start, end] = timeRange.split('-');
                        const startHour = parseInt(start.split(':')[0]);
                        const endHour = parseInt(end.split(':')[0]);
                        const hours = [];
                        for (let h = startHour; h < endHour; h++) {
                            hours.push(`${h.toString().padStart(2, '0')}-${(h + 1).toString().padStart(2, '0')}`);
                        }
                        selectedGymCenterHours[item.Day] = hours;
                    }
                });
                console.log('Parse edilen çalışma saatleri:', selectedGymCenterHours);
            } catch (e) {
                console.error('Çalışma saatleri parse hatası:', e, 'Raw data:', gymCenter.WorkingHoursJson);
                selectedGymCenterHours = {};
            }
            
            // Çalışma saatleri bölümünü göster ve render et
            if (Object.keys(selectedGymCenterHours).length > 0) {
                workingHoursSection.style.display = 'block';
                renderWorkingHours();
            } else {
                workingHoursSection.style.display = 'block';
                document.getElementById('workingHoursContainer').innerHTML = '<div class="alert alert-warning">Seçilen spor salonunun çalışma saatleri tanımlanmamış.</div>';
            }
        }

        document.getElementById('gymCenterSelect').addEventListener('change', loadGymCenterHours);

        // Sayfa yüklendiğinde mevcut spor salonunun saatlerini yükle
        if (document.getElementById('gymCenterSelect').value) {
            loadGymCenterHours();
        }

        // JSON'u güncelle
        function updateWorkingHoursJson() {
            const jsonInput = document.getElementById('workingHoursJsonInput');
            const dataArray = [];
            
            Object.keys(workingHoursData).forEach(day => {
                if (workingHoursData[day] && workingHoursData[day].length > 0) {
                    dataArray.push({
                        Day: parseInt(day),
                        Hours: workingHoursData[day]
                    });
                }
            });
            
            jsonInput.value = JSON.stringify(dataArray);
        }

        // Çalışma saatlerini render et
        function renderWorkingHours() {
            const container = document.getElementById('workingHoursContainer');
            container.innerHTML = '';
            
            if (Object.keys(selectedGymCenterHours).length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Seçilen spor salonunun çalışma saatleri tanımlanmamış.</div>';
                return;
            }
            
            console.log('Render ediliyor, selectedGymCenterHours:', selectedGymCenterHours);
            
            daysOfWeek.forEach(day => {
                // Day değerini hem number hem string olarak kontrol et
                const gymCenterHours = selectedGymCenterHours[day.value] || selectedGymCenterHours[day.value.toString()] || [];
                if (gymCenterHours.length === 0) {
                    return;
                }
                
                const trainerHours = workingHoursData[day.value] || [];
                const dayCard = document.createElement('div');
                dayCard.className = 'card mb-3';
                dayCard.innerHTML = `
                    <div class="card-header">
                        <div class="form-check">
                            <input class="form-check-input day-radio" 
                                   type="radio" 
                                   name="selectedDay" 
                                   id="day_${day.value}" 
                                   value="${day.value}">
                            <label class="form-check-label fw-bold" for="day_${day.value}">
                                ${day.text}
                            </label>
                        </div>
                    </div>
                    <div class="card-body" id="day_${day.value}_hours" style="display: none;">
                        <p class="text-muted small mb-2">Spor salonu bu gün şu saatlerde çalışıyor:</p>
                        <div class="row">
                            ${gymCenterHours.map(hour => {
                                const [start, end] = hour.split('-');
                                const hourText = `${start}:00 - ${end}:00`;
                                return `
                                    <div class="col-md-3 col-sm-4 col-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input hour-checkbox" 
                                                   type="checkbox" 
                                                   data-day="${day.value}" 
                                                   data-hour="${hour}" 
                                                   id="hour_${day.value}_${hour}" 
                                                   ${trainerHours.includes(hour) ? 'checked' : ''}>
                                            <label class="form-check-label" for="hour_${day.value}_${hour}">
                                                ${hourText}
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="saveDayHours(${day.value})">
                            <i class="bi bi-check"></i> Saatleri Kaydet
                        </button>
                    </div>
                `;
                container.appendChild(dayCard);

                const radio = dayCard.querySelector('.day-radio');
                radio.addEventListener('change', function() {
                    document.querySelectorAll('[id$="_hours"]').forEach(el => {
                        el.style.display = 'none';
                    });
                    if (this.checked) {
                        document.getElementById(`day_${day.value}_hours`).style.display = 'block';
                    }
                });
            });

            document.querySelectorAll('.hour-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const day = this.getAttribute('data-day');
                    const hour = this.getAttribute('data-hour');
                    
                    if (!workingHoursData[day]) {
                        workingHoursData[day] = [];
                    }
                    
                    if (this.checked) {
                        if (!workingHoursData[day].includes(hour)) {
                            workingHoursData[day].push(hour);
                        }
                    } else {
                        workingHoursData[day] = workingHoursData[day].filter(h => h !== hour);
                    }
                });
            });
        }

        // Gün saatlerini kaydet
        function saveDayHours(day) {
            const checkboxes = document.querySelectorAll(`.hour-checkbox[data-day="${day}"]`);
            const selectedHours = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.getAttribute('data-hour'));
            
            if (selectedHours.length === 0) {
                alert('Lütfen en az bir saat seçiniz.');
                return;
            }
            
            workingHoursData[day] = selectedHours;
            updateWorkingHoursJson();
            
            // Hata mesajını gizle (çalışma saati seçildi)
            const errorDiv = document.getElementById('workingHoursError');
            if (errorDiv) {
                errorDiv.classList.add('d-none');
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <strong>Başarılı!</strong> ${daysOfWeek.find(d => d.value === day)?.text} günü için ${selectedHours.length} saat kaydedildi.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById(`day_${day}_hours`).appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Sayfa yüklendiğinde eğer spor salonu seçiliyse çalışma saatlerini göster
        // DOMContentLoaded yerine window.onload kullan çünkü script sayfanın sonunda
        window.addEventListener('load', function() {
            const gymCenterSelect = document.getElementById('gymCenterSelect');
            if (gymCenterSelect && gymCenterSelect.value && gymCentersData.length > 0) {
                console.log('Sayfa yüklendi, spor salonu seçili:', gymCenterSelect.value);
                // Spor salonu seçiliyse change event'ini tetikle
                gymCenterSelect.dispatchEvent(new Event('change'));
            }
        });

        // Form submit öncesi validasyon ve tüm checkbox değişikliklerini kaydet
        document.querySelector('form').addEventListener('submit', function(e) {
            // Tüm checkbox'ları kontrol et ve workingHoursData'yı güncelle
            document.querySelectorAll('.hour-checkbox').forEach(checkbox => {
                const day = checkbox.getAttribute('data-day');
                const hour = checkbox.getAttribute('data-hour');
                
                if (!workingHoursData[day]) {
                    workingHoursData[day] = [];
                }
                
                if (checkbox.checked) {
                    if (!workingHoursData[day].includes(hour)) {
                        workingHoursData[day].push(hour);
                    }
                } else {
                    workingHoursData[day] = workingHoursData[day].filter(h => h !== hour);
                }
            });
            
            // JSON'u güncelle
            updateWorkingHoursJson();
            
            const jsonInput = document.getElementById('workingHoursJsonInput');
            const data = JSON.parse(jsonInput.value || '[]');
            const gymCenterId = document.getElementById('gymCenterSelect').value;
            const workingHoursSection = document.getElementById('workingHoursSection');
            const errorDiv = document.getElementById('workingHoursError');
            
            // Spor salonu seçilmişse çalışma saatleri zorunlu
            if (gymCenterId && gymCenterId !== '') {
                if (data.length === 0) {
                    e.preventDefault();
                    // Hata mesajını göster
                    if (errorDiv) {
                        errorDiv.classList.remove('d-none');
                    }
                    // Çalışma saatleri bölümünü göster
                    if (workingHoursSection) {
                        workingHoursSection.style.display = 'block';
                    }
                    // Sayfayı çalışma saatleri bölümüne kaydır
                    workingHoursSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                } else {
                    // Hata mesajını gizle
                    if (errorDiv) {
                        errorDiv.classList.add('d-none');
                    }
                }
            }
            
            console.log('Form submit ediliyor, WorkingHoursJson:', jsonInput.value);
        });
    </script>
}

