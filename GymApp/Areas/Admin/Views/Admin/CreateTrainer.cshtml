@model GymApp.Entities.Trainer
@{
    ViewData["Title"] = "Yeni Antrenör Ekle";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="bi bi-person-plus"></i> Yeni Antrenör Ekle</h3>
                </div>
                <div class="card-body">
                    <form id="createTrainerForm" onsubmit="return createTrainerViaApi(event)">
                        <div id="validationSummary" class="alert alert-danger mb-3" style="display: none;"></div>
                        <div id="successMessage" class="alert alert-success mb-3" style="display: none;"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label">Ad</label>
                                <input asp-for="FirstName" class="form-control" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label">Soyad</label>
                                <input asp-for="LastName" class="form-control" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">E-posta</label>
                            <input asp-for="Email" type="email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Phone" class="form-label">Telefon</label>
                            <input asp-for="Phone" class="form-control" />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ProfilePhotoUrl" class="form-label">Profil Fotoğrafı URL</label>
                            <input asp-for="ProfilePhotoUrl" type="url" class="form-control" placeholder="https://example.com/photo.jpg" />
                            <span asp-validation-for="ProfilePhotoUrl" class="text-danger"></span>
                            <small class="form-text text-muted">Antrenörün profil fotoğrafı için bir URL giriniz (opsiyonel).</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Uzmanlık Alanları (Aktiviteler) <span class="text-danger">*</span></label>
                            <small class="form-text text-muted d-block mb-2">Antrenörün yapabileceği aktiviteleri seçiniz.</small>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                @{
                                    var activities = ViewBag.Activities as List<GymApp.Entities.Activity> ?? new List<GymApp.Entities.Activity>();
                                }
                                @if (activities.Any())
                                {
                                    <div class="row">
                                        @foreach (var activity in activities)
                                        {
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input activity-checkbox" 
                                                           type="checkbox" 
                                                           name="SelectedActivityIds" 
                                                           value="@activity.Id" 
                                                           id="activity_@activity.Id" />
                                                    <label class="form-check-label" for="activity_@activity.Id">
                                                        @activity.Name
                                                        <small class="text-muted">(@activity.GymCenter?.Name)</small>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">Henüz aktivite eklenmemiş. Önce aktivite ekleyin.</p>
                                }
                            </div>
                            <input type="hidden" id="selectedActivityIdsInput" name="SelectedActivityIds" value="" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="GymCenterId" class="form-label">Spor Salonu <span class="text-danger">*</span></label>
                            <select asp-for="GymCenterId" class="form-select" id="gymCenterSelect" required>
                                <option value="">Spor Salonu Seçiniz</option>
                                @foreach (var gymCenter in ViewBag.GymCenters ?? new List<GymApp.Entities.GymCenter>())
                                {
                                    <option value="@gymCenter.Id">@gymCenter.Name</option>
                                }
                            </select>
                            <span asp-validation-for="GymCenterId" class="text-danger"></span>
                            <small class="form-text text-muted">Spor salonu seçildikten sonra çalışma saatleri görünecektir.</small>
                        </div>

                        <div class="mb-4" id="workingHoursSection" style="display: none;">
                            <label class="form-label fw-bold">Çalışma Saatleri <span class="text-danger">*</span></label>
                            <small class="form-text text-muted d-block mb-3">Seçilen spor salonunun çalışma saatleri içinden antrenörün çalışacağı saatleri seçiniz. <strong class="text-danger">En az bir gün için çalışma saati seçilmesi zorunludur.</strong></small>
                            <input type="hidden" asp-for="WorkingHoursJson" id="workingHoursJsonInput" value="[]" />
                            <div id="workingHoursError" class="alert alert-danger d-none mb-3" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Hata:</strong> En az bir gün için çalışma saati seçmeniz gerekmektedir.
                            </div>
                            <div id="workingHoursContainer">
                                <!-- Çalışma saatleri buraya eklenecek -->
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg"></i> Kaydet
                            </button>
                            <a href="@Url.Action("Trainers", "Admin")" class="btn btn-secondary">
                                <i class="bi bi-x-lg"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Aktivite seçimlerini yönet
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.activity-checkbox');
            const hiddenInput = document.getElementById('selectedActivityIdsInput');
            
            function updateSelectedActivities() {
                const selectedIds = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value)
                    .join(',');
                hiddenInput.value = selectedIds;
            }
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedActivities);
            });
            
            // Form submit öncesi kontrol
            document.querySelector('form').addEventListener('submit', function(e) {
                updateSelectedActivities();
                const selectedCount = hiddenInput.value.split(',').filter(id => id !== '').length;
                if (selectedCount === 0) {
                    e.preventDefault();
                    alert('Lütfen en az bir aktivite seçiniz.');
                    return false;
                }
            });
        });
        
        // Spor salonları ve çalışma saatleri
        let gymCentersData = [];
        try {
            // ViewBag'den gelen JSON'u direkt JavaScript değişkenine ata
            @if (ViewBag.GymCentersJson != null)
            {
                <text>
                gymCentersData = @Html.Raw(ViewBag.GymCentersJson);
                </text>
            }
            else
            {
                <text>
                gymCentersData = [];
                </text>
            }
            console.log('Yüklenen spor salonları:', gymCentersData);
            console.log('Spor salonu sayısı:', gymCentersData.length);
            
            // Eğer boşsa, dropdown'dan kontrol et ve oluştur
            if (gymCentersData.length === 0) {
                console.warn('JSON boş, dropdown\'dan oluşturuluyor...');
                const select = document.getElementById('gymCenterSelect');
                if (select) {
                    const options = Array.from(select.options).filter(opt => opt.value !== '');
                    console.log('Dropdown seçenekleri:', options.map(opt => ({ id: opt.value, name: opt.text })));
                    
                    // Dropdown'dan spor salonlarını oluştur (çalışma saatleri için server'a istek gerekebilir)
                    if (options.length > 0) {
                        gymCentersData = options.map(opt => ({
                            Id: parseInt(opt.value),
                            Name: opt.text,
                            WorkingHoursJson: "[]" // Varsayılan - çalışma saatleri için AJAX isteği yapılabilir
                        }));
                        console.log('Dropdown\'dan oluşturulan spor salonları:', gymCentersData);
                    }
                }
            }
        } catch (e) {
            console.error('Spor salonları yükleme hatası:', e);
            gymCentersData = [];
        }
        let workingHoursData = {}; // { "1": ["10-11", "11-12"], "2": ["14-15", "15-16"] }
        let selectedGymCenterHours = {}; // Seçilen spor salonunun çalışma saatleri
        
        const daysOfWeek = [
            { value: 0, text: 'Pazar' },
            { value: 1, text: 'Pazartesi' },
            { value: 2, text: 'Salı' },
            { value: 3, text: 'Çarşamba' },
            { value: 4, text: 'Perşembe' },
            { value: 5, text: 'Cuma' },
            { value: 6, text: 'Cumartesi' }
        ];

        // Spor salonu seçildiğinde
        document.getElementById('gymCenterSelect').addEventListener('change', function() {
            const gymCenterId = this.value;
            const workingHoursSection = document.getElementById('workingHoursSection');
            
            if (!gymCenterId) {
                workingHoursSection.style.display = 'none';
                return;
            }
            
            // Seçilen spor salonunun çalışma saatlerini bul
            const gymCenterIdNum = parseInt(gymCenterId);
            console.log('Aranan spor salonu ID:', gymCenterIdNum);
            console.log('Mevcut spor salonları:', gymCentersData);
            
            let gymCenter = gymCentersData.find(gc => {
                const gcId = typeof gc.Id === 'string' ? parseInt(gc.Id) : gc.Id;
                return gcId === gymCenterIdNum;
            });
            
            // Eğer bulunamadıysa ve gymCentersData boşsa, dropdown'dan çalışma saatlerini almak için
            // server'a AJAX isteği yapabiliriz, ama şimdilik basit bir çözüm:
            if (!gymCenter) {
                console.warn('JSON\'dan spor salonu bulunamadı, dropdown kontrol ediliyor...');
                // Dropdown'dan seçili option'ı al
                const select = document.getElementById('gymCenterSelect');
                const selectedOption = select ? select.options[select.selectedIndex] : null;
                if (selectedOption && selectedOption.value === gymCenterId) {
                    // ViewBag'den çalışma saatlerini almak için sayfayı yeniden yükleyebiliriz
                    // veya AJAX ile çalışma saatlerini çekebiliriz
                    // Şimdilik boş çalışma saatleri ile devam et
                    gymCenter = {
                        Id: gymCenterIdNum,
                        Name: selectedOption.text,
                        WorkingHoursJson: "[]"
                    };
                    console.log('Dropdown\'dan oluşturulan spor salonu:', gymCenter);
                }
            }
            
            if (!gymCenter) {
                console.error('Spor salonu bulunamadı. ID:', gymCenterId, 'Mevcut salonlar:', gymCentersData);
                alert('Spor salonu bulunamadı. Lütfen sayfayı yenileyin.');
                workingHoursSection.style.display = 'none';
                return;
            }
            
            console.log('Spor salonu bulundu:', gymCenter);
            
            // Çalışma saatlerini parse et
            try {
                const hoursData = JSON.parse(gymCenter.WorkingHoursJson || '[]');
                selectedGymCenterHours = {};
                hoursData.forEach(item => {
                    if (item.Hours && Array.isArray(item.Hours)) {
                        selectedGymCenterHours[item.Day] = item.Hours;
                    } else if (item.TimeRange) {
                        // Eski format desteği - TimeRange'i Hours array'ine çevir
                        const timeRange = item.TimeRange;
                        const [start, end] = timeRange.split('-');
                        const startHour = parseInt(start.split(':')[0]);
                        const endHour = parseInt(end.split(':')[0]);
                        const hours = [];
                        for (let h = startHour; h < endHour; h++) {
                            hours.push(`${h.toString().padStart(2, '0')}-${(h + 1).toString().padStart(2, '0')}`);
                        }
                        selectedGymCenterHours[item.Day] = hours;
                    }
                });
                console.log('Parse edilen çalışma saatleri:', selectedGymCenterHours);
            } catch (e) {
                console.error('Çalışma saatleri parse hatası:', e, 'Raw data:', gymCenter.WorkingHoursJson);
                selectedGymCenterHours = {};
            }
            
            // Çalışma saatleri bölümünü göster ve render et
            if (Object.keys(selectedGymCenterHours).length > 0) {
                workingHoursSection.style.display = 'block';
                renderWorkingHours();
            } else {
                workingHoursSection.style.display = 'block';
                document.getElementById('workingHoursContainer').innerHTML = '<div class="alert alert-warning">Seçilen spor salonunun çalışma saatleri tanımlanmamış.</div>';
            }
        });

        // JSON'u güncelle
        function updateWorkingHoursJson() {
            const jsonInput = document.getElementById('workingHoursJsonInput');
            const dataArray = [];
            
            Object.keys(workingHoursData).forEach(day => {
                if (workingHoursData[day] && workingHoursData[day].length > 0) {
                    dataArray.push({
                        Day: parseInt(day),
                        Hours: workingHoursData[day]
                    });
                }
            });
            
            jsonInput.value = JSON.stringify(dataArray);
        }

        // Çalışma saatlerini render et
        function renderWorkingHours() {
            const container = document.getElementById('workingHoursContainer');
            container.innerHTML = '';
            
            if (Object.keys(selectedGymCenterHours).length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Seçilen spor salonunun çalışma saatleri tanımlanmamış.</div>';
                return;
            }
            
            console.log('Render ediliyor, selectedGymCenterHours:', selectedGymCenterHours);
            
            daysOfWeek.forEach(day => {
                // Day değerini hem number hem string olarak kontrol et
                const gymCenterHours = selectedGymCenterHours[day.value] || selectedGymCenterHours[day.value.toString()] || [];
                if (gymCenterHours.length === 0) {
                    return; // Bu gün için spor salonu çalışmıyor
                }
                
                const trainerHours = workingHoursData[day.value] || [];
                const dayCard = document.createElement('div');
                dayCard.className = 'card mb-3';
                dayCard.innerHTML = `
                    <div class="card-header">
                        <div class="form-check">
                            <input class="form-check-input day-radio" 
                                   type="radio" 
                                   name="selectedDay" 
                                   id="day_${day.value}" 
                                   value="${day.value}">
                            <label class="form-check-label fw-bold" for="day_${day.value}">
                                ${day.text}
                            </label>
                        </div>
                    </div>
                    <div class="card-body" id="day_${day.value}_hours" style="display: none;">
                        <p class="text-muted small mb-2">Spor salonu bu gün şu saatlerde çalışıyor:</p>
                        <div class="row">
                            ${gymCenterHours.map(hour => {
                                const [start, end] = hour.split('-');
                                const hourText = `${start}:00 - ${end}:00`;
                                return `
                                    <div class="col-md-3 col-sm-4 col-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input hour-checkbox" 
                                                   type="checkbox" 
                                                   data-day="${day.value}" 
                                                   data-hour="${hour}" 
                                                   id="hour_${day.value}_${hour}" 
                                                   ${trainerHours.includes(hour) ? 'checked' : ''}>
                                            <label class="form-check-label" for="hour_${day.value}_${hour}">
                                                ${hourText}
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="saveDayHours(${day.value})">
                            <i class="bi bi-check"></i> Saatleri Kaydet
                        </button>
                    </div>
                `;
                container.appendChild(dayCard);

                // Radio button event listener
                const radio = dayCard.querySelector('.day-radio');
                radio.addEventListener('change', function() {
                    document.querySelectorAll('[id$="_hours"]').forEach(el => {
                        el.style.display = 'none';
                    });
                    if (this.checked) {
                        document.getElementById(`day_${day.value}_hours`).style.display = 'block';
                    }
                });
            });

            // Checkbox event listeners
            document.querySelectorAll('.hour-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const day = this.getAttribute('data-day');
                    const hour = this.getAttribute('data-hour');
                    
                    if (!workingHoursData[day]) {
                        workingHoursData[day] = [];
                    }
                    
                    if (this.checked) {
                        if (!workingHoursData[day].includes(hour)) {
                            workingHoursData[day].push(hour);
                        }
                    } else {
                        workingHoursData[day] = workingHoursData[day].filter(h => h !== hour);
                    }
                });
            });
        }

        // Gün saatlerini kaydet
        function saveDayHours(day) {
            const checkboxes = document.querySelectorAll(`.hour-checkbox[data-day="${day}"]`);
            const selectedHours = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.getAttribute('data-hour'));
            
            if (selectedHours.length === 0) {
                alert('Lütfen en az bir saat seçiniz.');
                return;
            }
            
            workingHoursData[day] = selectedHours;
            updateWorkingHoursJson();
            
            // Hata mesajını gizle (çalışma saati seçildi)
            const errorDiv = document.getElementById('workingHoursError');
            if (errorDiv) {
                errorDiv.classList.add('d-none');
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <strong>Başarılı!</strong> ${daysOfWeek.find(d => d.value === day)?.text} günü için ${selectedHours.length} saat kaydedildi.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById(`day_${day}_hours`).appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Sayfa yüklendiğinde eğer spor salonu seçiliyse çalışma saatlerini göster
        // DOMContentLoaded yerine window.onload kullan çünkü script sayfanın sonunda
        window.addEventListener('load', function() {
            const gymCenterSelect = document.getElementById('gymCenterSelect');
            if (gymCenterSelect && gymCenterSelect.value && gymCentersData.length > 0) {
                console.log('Sayfa yüklendi, spor salonu seçili:', gymCenterSelect.value);
                // Spor salonu seçiliyse change event'ini tetikle
                gymCenterSelect.dispatchEvent(new Event('change'));
            }
        });

        // Form submit öncesi validasyon ve tüm checkbox değişikliklerini kaydet
        document.querySelector('form').addEventListener('submit', function(e) {
            console.log('Form submit başladı...');
            
            // Tüm checkbox'ları kontrol et ve workingHoursData'yı güncelle
            document.querySelectorAll('.hour-checkbox').forEach(checkbox => {
                const day = checkbox.getAttribute('data-day');
                const hour = checkbox.getAttribute('data-hour');
                
                if (!workingHoursData[day]) {
                    workingHoursData[day] = [];
                }
                
                if (checkbox.checked) {
                    if (!workingHoursData[day].includes(hour)) {
                        workingHoursData[day].push(hour);
                    }
                } else {
                    workingHoursData[day] = workingHoursData[day].filter(h => h !== hour);
                }
            });
            
            // JSON'u güncelle
            updateWorkingHoursJson();
            
            const jsonInput = document.getElementById('workingHoursJsonInput');
            const data = JSON.parse(jsonInput.value || '[]');
            const gymCenterId = document.getElementById('gymCenterSelect').value;
            const workingHoursSection = document.getElementById('workingHoursSection');
            const errorDiv = document.getElementById('workingHoursError');
            
            console.log('GymCenterId:', gymCenterId);
            console.log('WorkingHoursJson:', jsonInput.value);
            console.log('Parsed data length:', data.length);
            
            // Spor salonu seçilmişse ve çalışma saatleri bölümü görünüyorsa çalışma saatleri zorunlu
            if (gymCenterId && gymCenterId !== '' && workingHoursSection && workingHoursSection.style.display !== 'none') {
                // Çalışma saatleri bölümü görünüyorsa ve seçim yapılmamışsa zorunlu
                const hasWorkingHoursOptions = document.querySelectorAll('.hour-checkbox').length > 0;
                
                if (hasWorkingHoursOptions && data.length === 0) {
                    e.preventDefault();
                    console.error('Çalışma saati seçilmedi, form submit engellendi');
                    // Hata mesajını göster
                    if (errorDiv) {
                        errorDiv.classList.remove('d-none');
                    }
                    // Çalışma saatleri bölümünü göster
                    if (workingHoursSection) {
                        workingHoursSection.style.display = 'block';
                    }
                    // Sayfayı çalışma saatleri bölümüne kaydır
                    workingHoursSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                } else {
                    // Hata mesajını gizle
                    if (errorDiv) {
                        errorDiv.classList.add('d-none');
                    }
                    if (data.length > 0) {
                        console.log('Çalışma saatleri seçildi, form submit ediliyor...');
                    } else {
                        console.log('Çalışma saatleri seçenekleri yok, form submit ediliyor...');
                    }
                }
            } else {
                console.log('Spor salonu seçilmedi veya çalışma saatleri bölümü görünmüyor, form submit ediliyor...');
            }
            
            // Form submit ediliyor
            console.log('Form submit onaylandı');
            return true;
        });
    </script>

<script>
    // Aktivite listesini API'den yükle
    async function loadActivities() {
        try {
            const response = await fetch('/api/api/activities');
            if (!response.ok) throw new Error('HTTP ' + response.status);
            
            const result = await response.json();
            if (result.success && result.data) {
                const container = document.querySelector('.border.rounded.p-3');
                if (container) {
                    container.innerHTML = '<div class="row">';
                    result.data.forEach(activity => {
                        const div = document.createElement('div');
                        div.className = 'col-md-6 mb-2';
                        div.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input activity-checkbox" 
                                       type="checkbox" 
                                       name="SelectedActivityIds" 
                                       value="${activity.id}" 
                                       id="activity_${activity.id}" />
                                <label class="form-check-label" for="activity_${activity.id}">
                                    ${activity.name}
                                    <small class="text-muted">(${activity.gymCenterName || 'N/A'})</small>
                                </label>
                            </div>
                        `;
                        container.querySelector('.row').appendChild(div);
                    });
                    container.innerHTML += '</div>';
                }
            }
        } catch (error) {
            console.error('Aktiviteler yüklenirken hata:', error);
        }
    }

    // Spor salonlarını API'den yükle
    async function loadGymCenters() {
        try {
            const response = await fetch('/api/api/gym-centers');
            if (!response.ok) throw new Error('HTTP ' + response.status);
            
            const result = await response.json();
            if (result.success && result.data) {
                const select = document.getElementById('gymCenterSelect');
                if (select) {
                    select.innerHTML = '<option value="">Spor Salonu Seçiniz</option>';
                    result.data.forEach(gc => {
                        const option = document.createElement('option');
                        option.value = gc.id;
                        option.textContent = gc.name;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Spor salonları yüklenirken hata:', error);
        }
    }

    // API üzerinden antrenör oluşturma
    async function createTrainerViaApi(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        const validationSummary = document.getElementById('validationSummary');
        const successMessage = document.getElementById('successMessage');
        
        // Form verilerini topla
        const selectedActivityIds = Array.from(document.querySelectorAll('.activity-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        
        // Specialization'ı seçilen aktivitelerden oluştur
        let specialization = '';
        if (selectedActivityIds.length > 0) {
            const activityNames = [];
            document.querySelectorAll('.activity-checkbox:checked').forEach(checkbox => {
                const label = checkbox.closest('.form-check').querySelector('label');
                if (label) {
                    const activityName = label.textContent.split('(')[0].trim();
                    if (activityName && !activityNames.includes(activityName)) {
                        activityNames.push(activityName);
                    }
                }
            });
            specialization = activityNames.join(', ') || 'Belirtilmemiş';
        } else {
            specialization = 'Belirtilmemiş';
        }
        
        const workingHoursData = [];
        document.querySelectorAll('.day-working-hours').forEach(dayDiv => {
            const day = parseInt(dayDiv.dataset.day);
            const selectedHours = Array.from(dayDiv.querySelectorAll('.hour-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedHours.length > 0) {
                workingHoursData.push({
                    Day: day,
                    Hours: selectedHours
                });
            }
        });
        
        // API camelCase bekliyor
        const trainerData = {
            firstName: document.querySelector('input[name="FirstName"]').value.trim(),
            lastName: document.querySelector('input[name="LastName"]').value.trim(),
            email: document.querySelector('input[name="Email"]').value.trim(),
            phone: document.querySelector('input[name="Phone"]').value.trim(),
            profilePhotoUrl: document.querySelector('input[name="ProfilePhotoUrl"]')?.value.trim() || '',
            gymCenterId: parseInt(document.getElementById('gymCenterSelect').value) || 0,
            specialization: specialization,
            password: document.querySelector('input[name="Password"]')?.value || 'default123',
            workingHoursJson: JSON.stringify(workingHoursData),
            trainerActivities: selectedActivityIds.map(id => ({ activityId: id }))
        };
        
        // Validasyon
        if (!trainerData.firstName || trainerData.firstName.trim() === '') {
            showValidationError('Ad alanı zorunludur.');
            return false;
        }
        
        if (!trainerData.lastName || trainerData.lastName.trim() === '') {
            showValidationError('Soyad alanı zorunludur.');
            return false;
        }
        
        var atSymbol = String.fromCharCode(64); // 64 = at işareti karakterinin ASCII kodu
        var emailAtIndex = trainerData.email.indexOf(atSymbol);
        if (emailAtIndex === -1 || emailAtIndex === 0 || emailAtIndex === trainerData.email.length - 1) {
            showValidationError('Geçerli bir e-posta adresi giriniz.');
            return false;
        }
        
        if (!trainerData.gymCenterId || trainerData.gymCenterId <= 0) {
            showValidationError('Lütfen bir spor salonu seçiniz.');
            return false;
        }
        
        // Loading durumu
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Kaydediliyor...';
        validationSummary.style.display = 'none';
        successMessage.style.display = 'none';
        
        try {
            const response = await fetch('/api/api/trainers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                credentials: 'include',
                body: JSON.stringify(trainerData)
            });
            
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    
                    if (errorData.errors) {
                        // ModelState hatalarını göster
                        const errorMessages = [];
                        Object.keys(errorData.errors).forEach(key => {
                            const fieldErrors = errorData.errors[key];
                            if (Array.isArray(fieldErrors)) {
                                fieldErrors.forEach(err => {
                                    errorMessages.push(`${key}: ${err}`);
                                });
                            } else {
                                errorMessages.push(`${key}: ${fieldErrors}`);
                            }
                        });
                        errorMessage = errorMessages.join('; ') || errorData.message || errorMessage;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    }
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    const text = await response.text().catch(() => '');
                    errorMessage = `HTTP ${response.status}: ${text || 'Bilinmeyen hata'}`;
                }
                throw new Error(errorMessage);
            }
            
            const result = await response.json();
            if (result.success) {
                successMessage.textContent = 'Antrenör başarıyla oluşturuldu! Yönlendiriliyorsunuz...';
                successMessage.style.display = 'block';
                
                setTimeout(() => {
                    window.location.href = '/Admin/Admin/Trainers';
                }, 2000);
            } else {
                throw new Error(result.message || 'Antrenör oluşturulamadı');
            }
        } catch (error) {
            console.error('Create trainer error:', error);
            showValidationError('Antrenör oluşturulurken hata oluştu: ' + error.message);
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        }
        
        return false;
    }
    
    function showValidationError(message) {
        const validationSummary = document.getElementById('validationSummary');
        validationSummary.innerHTML = '<ul class="mb-0"><li>' + message + '</li></ul>';
        validationSummary.style.display = 'block';
    }

    // Sayfa yüklendiğinde verileri yükle
    document.addEventListener('DOMContentLoaded', function() {
        loadActivities();
        loadGymCenters();
    });
</script>
}

