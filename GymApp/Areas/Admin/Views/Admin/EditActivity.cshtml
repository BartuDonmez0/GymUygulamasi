@model GymApp.Entities.Activity
@{
    ViewData["Title"] = "Aktivite Düzenle";
    var gymCenters = ViewBag.GymCenters as List<GymApp.Entities.GymCenter> ?? new List<GymApp.Entities.GymCenter>();
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0"><i class="bi bi-pencil"></i> Aktivite Düzenle</h3>
                </div>
                <div class="card-body">
                    <form id="editActivityForm" onsubmit="return updateActivityViaApi(event, @Model.Id)">
                        <input type="hidden" id="ActivityId" value="@Model.Id" />
                        <div id="validationSummary" class="text-danger mb-3" style="display: none;"></div>

                        <div class="mb-3">
                            <label asp-for="GymCenterId" class="form-label">Spor Salonu</label>
                            <select asp-for="GymCenterId" class="form-select" required>
                                <option value="">Spor Salonu Seçiniz</option>
                                @foreach (var gymCenter in gymCenters)
                                {
                                    <option value="@gymCenter.Id">@gymCenter.Name</option>
                                }
                            </select>
                            <span asp-validation-for="GymCenterId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">Aktivite Adı</label>
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Açıklama</label>
                            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Type" class="form-label">Aktivite Tipi</label>
                            <select asp-for="Type" class="form-select" required>
                                <option value="">Aktivite Tipi Seçiniz</option>
                                @{
                                    var activityTypes = new Dictionary<int, string>
                                    {
                                        { 1, "Fitness" }, { 2, "Yoga" }, { 3, "Pilates" }, { 4, "Crossfit" }, { 5, "Zumba" },
                                        { 6, "Spinning" }, { 7, "Kickboxing" }, { 8, "Kişisel Antrenman" }, { 9, "Grup Antrenmanı" },
                                        { 10, "Kardiyovasküler" }, { 11, "Güç Antrenmanı" }, { 12, "Esneklik" }, { 13, "Dans" },
                                        { 14, "Aerobik" }, { 15, "Vücut Geliştirme" }, { 16, "Boks" }, { 17, "Muay Thai" },
                                        { 18, "Brezilya Jiu Jitsu" }, { 19, "Karate" }, { 20, "Tae Kwon Do" }, { 21, "Yüzme" },
                                        { 22, "Su Aerobiği" }, { 23, "Su Topu" }, { 24, "Basketbol" }, { 25, "Futbol" },
                                        { 26, "Voleybol" }, { 27, "Tenis" }, { 28, "Badminton" }, { 29, "Masa Tenisi" },
                                        { 30, "Squash" }, { 31, "Raketbol" }, { 32, "Koşu" }, { 33, "Jogging" },
                                        { 34, "Yürüyüş" }, { 35, "Doğa Yürüyüşü" }, { 36, "Bisiklet" }, { 37, "Kapalı Bisiklet" },
                                        { 38, "Kürek" }, { 39, "Tırmanış" }, { 40, "Kaya Tırmanışı" }, { 41, "Bouldering" },
                                        { 42, "Jimnastik" }, { 43, "Kalistenik" }, { 44, "TRX" }, { 45, "Kettlebell" },
                                        { 46, "Fonksiyonel Antrenman" }, { 47, "HIIT" }, { 48, "Tabata" }, { 49, "Devre Antrenmanı" },
                                        { 50, "Boot Camp" }, { 51, "Barre" }, { 52, "Bale" }, { 53, "Modern Dans" },
                                        { 54, "Latin Dans" }, { 55, "Hip Hop" }, { 56, "Oryantal Dans" }, { 57, "Pole Dance" },
                                        { 58, "Aerial Yoga" }, { 59, "Hot Yoga" }, { 60, "Power Yoga" }, { 61, "Yin Yoga" },
                                        { 62, "Ashtanga Yoga" }, { 63, "Vinyasa Yoga" }, { 64, "Hatha Yoga" }, { 65, "Pilates Mat" },
                                        { 66, "Reformer Pilates" }, { 67, "Barre Pilates" }, { 68, "Meditasyon" }, { 69, "Farkındalık" },
                                        { 70, "Tai Chi" }, { 71, "Qigong" }, { 72, "Dövüş Sanatları" }, { 73, "Güreş" },
                                        { 74, "Judo" }, { 75, "Aikido" }, { 76, "Capoeira" }, { 77, "MMA" },
                                        { 78, "Öz Savunma" }, { 79, "Krav Maga" }, { 80, "Kilo Verme" }, { 81, "Kas Geliştirme" },
                                        { 82, "Rehabilitasyon" }, { 83, "Fizik Tedavi" }, { 84, "Yaşlılar İçin Fitness" }, { 85, "Çocuk Fitness" },
                                        { 86, "Hamile Yoga" }, { 87, "Doğum Sonrası Yoga" }, { 88, "Spor Masajı" }, { 89, "Esneklik Dersi" },
                                        { 90, "Esneklik Antrenmanı" }, { 91, "Mobilite Antrenmanı" }, { 92, "Core Antrenmanı" }, { 93, "Karın Antrenmanı" },
                                        { 94, "Kalça Antrenmanı" }, { 95, "Bacak Antrenmanı" }, { 96, "Kol Antrenmanı" }, { 97, "Sırt Antrenmanı" },
                                        { 98, "Göğüs Antrenmanı" }, { 99, "Omuz Antrenmanı" }, { 100, "Tüm Vücut Antrenmanı" }
                                    };
                                }
                                @foreach (var type in activityTypes)
                                {
                                    <option value="@type.Key" selected="@((int)Model.Type == type.Key)">@type.Value</option>
                                }
                            </select>
                            <span asp-validation-for="Type" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label">Süre (Dakika)</label>
                                <input asp-for="Duration" type="number" class="form-control" min="1" />
                                <span asp-validation-for="Duration" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Price" class="form-label">Fiyat (₺)</label>
                                <input asp-for="Price" type="number" step="0.01" class="form-control" min="0" />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ImageUrl" class="form-label">Görsel URL (Opsiyonel)</label>
                            <input asp-for="ImageUrl" type="text" class="form-control" placeholder="https://example.com/image.jpg" />
                            <span asp-validation-for="ImageUrl" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-check-lg"></i> Güncelle
                            </button>
                            <a href="@Url.Action("Activities", "Admin")" class="btn btn-secondary">
                                <i class="bi bi-x-lg"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // API üzerinden aktivite güncelleme
        async function updateActivityViaApi(event, activityId) {
            event.preventDefault();
            
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            const validationSummary = document.getElementById('validationSummary');
            
            // Form verilerini topla (API camelCase bekliyor)
            const gymCenterIdValue = document.querySelector('select[name="GymCenterId"]').value;
            const activityData = {
                id: activityId,
                gymCenterId: parseInt(gymCenterIdValue) || 0,
                name: document.querySelector('input[name="Name"]').value.trim(),
                description: document.querySelector('textarea[name="Description"]').value.trim(),
                type: parseInt(document.querySelector('select[name="Type"]').value) || 0,
                duration: parseInt(document.querySelector('input[name="Duration"]').value) || 0,
                price: parseFloat(document.querySelector('input[name="Price"]').value) || 0,
                imageUrl: document.querySelector('input[name="ImageUrl"]')?.value.trim() || ''
            };
            
            // Validasyon
            if (!activityData.gymCenterId || activityData.gymCenterId <= 0) {
                showValidationError('Lütfen bir spor salonu seçin.');
                return false;
            }
            
            if (!activityData.name || activityData.name.trim() === '') {
                showValidationError('Aktivite adı zorunludur.');
                return false;
            }
            
            if (!activityData.type || activityData.type <= 0) {
                showValidationError('Lütfen bir aktivite tipi seçin.');
                return false;
            }
            
            if (activityData.duration <= 0) {
                showValidationError('Süre 1 dakikadan fazla olmalıdır.');
                return false;
            }
            
            if (activityData.price < 0) {
                showValidationError('Fiyat 0 veya daha büyük olmalıdır.');
                return false;
            }
            
            // Loading durumu
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Güncelleniyor...';
            validationSummary.style.display = 'none';
            
            try {
                const response = await fetch(`/api/api/activities/${activityId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(activityData)
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('API Error Response:', errorData);
                        
                        if (errorData.errors) {
                            // ModelState hatalarını göster
                            const errorMessages = [];
                            Object.keys(errorData.errors).forEach(key => {
                                const fieldErrors = errorData.errors[key];
                                if (Array.isArray(fieldErrors)) {
                                    fieldErrors.forEach(err => {
                                        errorMessages.push(`${key}: ${err}`);
                                    });
                                } else {
                                    errorMessages.push(`${key}: ${fieldErrors}`);
                                }
                            });
                            errorMessage = errorMessages.join('; ') || errorData.message || errorMessage;
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) {
                        console.error('Error parsing response:', parseError);
                        const text = await response.text().catch(() => '');
                        errorMessage = `HTTP ${response.status}: ${text || 'Bilinmeyen hata'}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                if (result.success) {
                    alert('Aktivite başarıyla güncellendi!');
                    window.location.href = '/Admin/Admin/Activities';
                } else {
                    throw new Error(result.message || 'Aktivite güncellenemedi');
                }
            } catch (error) {
                console.error('Update error:', error);
                showValidationError('Aktivite güncellenirken hata oluştu: ' + error.message);
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
            
            return false;
        }
        
        function showValidationError(message) {
            const validationSummary = document.getElementById('validationSummary');
            validationSummary.innerHTML = '<ul class="mb-0"><li>' + message + '</li></ul>';
            validationSummary.style.display = 'block';
        }
    </script>
}

